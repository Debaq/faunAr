<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Visor Anatomía AR</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Evita scroll */
        }

        /* --- PANTALLA DE CARGA (LOADING) --- */
        #pantalla-carga {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.5s;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00d2ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- TARJETA DE INFORMACIÓN (UI) --- */
        #tarjeta-info {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; /* Oculto al inicio */
            z-index: 100;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        #titulo-parte {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: capitalize;
        }

        #subtitulo-grupo {
            margin: 0 0 15px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        #btn-reset {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
            transition: transform 0.1s;
        }

        #btn-reset:active {
            transform: scale(0.95);
        }
    </style>

    <script>
        // COMPONENTE PRINCIPAL: GESTOR DE ANATOMÍA
        AFRAME.registerComponent('gestor-anatomia', {
            init: function () {
                const el = this.el; // Referencia al modelo 3D

                // Referencias a elementos del DOM (HTML)
                const pantallaCarga = document.getElementById('pantalla-carga');
                const textoCarga = document.getElementById('texto-carga');
                const tarjetaInfo = document.getElementById('tarjeta-info');
                const tituloUI = document.getElementById('titulo-parte');
                const subtituloUI = document.getElementById('subtitulo-grupo');
                const btnReset = document.getElementById('btn-reset');

                let modeloMesh = null; // Guardaremos aquí la referencia al objeto 3D real

                // --- 1. FUNCIÓN: Restablecer vista (Mostrar todo) ---
                const resetearVista = () => {
                    if (!modeloMesh) return;

                    // Recorremos todo el modelo y devolvemos la opacidad a 1
                    modeloMesh.traverse((node) => {
                        if (node.isMesh && node.material) {
                            node.material.opacity = 1.0;
                            node.material.transparent = false;
                            node.material.needsUpdate = true;
                        }
                    });

                    // Ocultamos la tarjeta
                    tarjetaInfo.style.display = 'none';
                };

                // Asignamos la función al botón de la pantalla
                btnReset.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita clics fantasma
                    resetearVista();
                });

                // --- 2. EVENTO: MODELO CARGADO ---
                el.addEventListener('model-loaded', () => {
                    console.log("Modelo 3D cargado exitosamente.");

                    // Ocultamos pantalla de carga
                    pantallaCarga.style.display = 'none';

                    // Preparamos los materiales para soportar transparencia
                    const obj = el.getObject3D('mesh');
                    modeloMesh = obj;

                    obj.traverse((node) => {
                        if (node.isMesh) {
                            // Vinculamos el nodo a la entidad de A-Frame para eventos
                            node.el = el;

                            // CLAVE: Clonamos el material. Si no hacemos esto,
                            // al cambiar la opacidad de un hueso, se cambiarían TODOS.
                            if (node.material) {
                                node.material = node.material.clone();
                                // Aseguramos que el motor de renderizado actualice esto
                                node.material.needsUpdate = true;
                            }
                        }
                    });
                });

                // --- 3. EVENTO: ERROR DE CARGA ---
                el.addEventListener('model-error', (error) => {
                    console.error("Error al cargar modelo:", error);
                    textoCarga.innerText = "Error: No se pudo cargar el archivo .glb";
                    textoCarga.style.color = "#ff4444";
                });

                // --- 4. EVENTO: CLIC EN EL MODELO (RAYCASTER) ---
                el.addEventListener('click', (evt) => {
                    // Verificamos si el rayo chocó con algo
                    if (evt.detail.intersection) {

                        const objetoTocado = evt.detail.intersection.object;

                        // Obtenemos nombres y limpiamos los guiones bajos (_)
                        let nombre = objetoTocado.name || "Desconocido";
                        let padre = (objetoTocado.parent && objetoTocado.parent.name) ? objetoTocado.parent.name : "Sistema General";

                        // Formatear texto para que se vea bonito (reemplazar _ por espacio)
                        nombre = nombre.replace(/_/g, " ");
                        padre = padre.replace(/_/g, " ");

                        console.log("Clic en:", nombre, "| Grupo:", padre);

                        // ACTUALIZAR LA INTERFAZ (UI)
                        tituloUI.innerText = nombre;
                        subtituloUI.innerText = padre;
                        tarjetaInfo.style.display = 'block';

                        // LOGICA DE AISLAMIENTO (GHOST MODE)
                        // Recorremos todo el modelo de nuevo
                        modeloMesh.traverse((node) => {
                            if (node.isMesh && node.material) {
                                if (node === objetoTocado) {
                                    // LA PARTE TOCADA: Sólida y visible
                                    node.material.opacity = 1.0;
                                    node.material.transparent = false;
                                    // Opcional: Color emisivo para resaltar
                                    // node.material.emissive.setHex(0x333333);
                                } else {
                                    // EL RESTO: Transparente (Fantasma)
                                    node.material.transparent = true;
                                    node.material.opacity = 0.1; // Ajusta este valor (0.05 a 0.2)
                                }
                                node.material.needsUpdate = true;
                            }
                        });
                    }
                });
            }
        });
    </script>
</head>
<body>

    <div id="pantalla-carga">
        <div class="spinner"></div>
        <div id="texto-carga">Descargando modelo 3D...<br>Por favor espera</div>
    </div>

    <div id="tarjeta-info">
        <h3 id="titulo-parte">Nombre de la Parte</h3>
        <p id="subtitulo-grupo">Grupo Anatómico</p>
        <button id="btn-reset">Mostrar Cuerpo Completo</button>
    </div>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;"
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false">
            <a-entity
                cursor="fuse: false; rayOrigin: mouse;"
                raycaster="far: 10000; interval: 100;">
            </a-entity>
        </a-camera>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" position="0 5 5" intensity="0.5"></a-light>

        <a-entity mindar-image-target="targetIndex: 0">

            <a-entity
                src="#modelo-anatomia"
                gltf-model="./assets/modelo_anatomia.glb"
                scale="1 1 1"
                position="0 0 0"
                gestor-anatomia>
            </a-entity>

        </a-entity>
    </a-scene>

</body>
</html>
